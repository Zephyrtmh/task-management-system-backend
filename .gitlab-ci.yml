stages:
  - transfer_build
  - build
  - transfer_bin

variables:
  BUILD_SVR_PATH: "C:\\Users\\commonuser\\Documents\\mss-academy-projects\\specialization\\build_svr"

copy_to_local_folder:
  stage: transfer_build
  script:
    - Write-Host "Executing copy"
    - $match = $env:CI_COMMIT_REF_NAME -match "^r_jsb_\d+_\d+$"
    - if ($match) {
        if (Test-Path "$BUILD_SVR_PATH\$env:CI_COMMIT_REF_NAME") {
          Remove-Item -Path "$BUILD_SVR_PATH\$env:CI_COMMIT_REF_NAME" -Recurse -Force;
        }
        New-Item -Path "$BUILD_SVR_PATH\$env:CI_COMMIT_REF_NAME" -ItemType Directory -Force;
        Copy-Item -Path "$env:CI_PROJECT_DIR\*" -Destination "$BUILD_SVR_PATH\$env:CI_COMMIT_REF_NAME" -Recurse;
      } else {
        Write-Host "Branch name does not match the pattern. Skipping..."
      }
  only:
    - branches

build_jar_file:
  stage: build
  script:
    - ./build/build.sh
  artifacts:
    paths:
      - ./target/$env:CI_COMMIT_REF_NAME.jar

# copy_to_local_folder:
#   stage: transfer_bin
#   script:
#     - Write-Host "Executing copy"
#     - $match = $env:CI_COMMIT_REF_NAME -match "^r_jsb_\d+_\d+$"
#     - if ($match) {
#         New-Item -Path "C:\Users\commonuser\Documents\mss-academy-projects\specialization\build_svr" -ItemType Directory -Force;
#         Copy-Item -Path "$env:CI_PROJECT_DIR\*" -Destination "C:\Users\commonuser\Documents\mss-academy-projects\specialization\build_svr" -Recurse;
#       } else {
#         Write-Host "Branch name does not match the pattern. Skipping..."
#       }
#   only:
#     - branches